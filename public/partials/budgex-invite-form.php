<?php
/**
 * Budgex Invite Form Template
 * 
 * This file provides the form for inviting other users to view or manage budgets.
 * Integrates with the enhanced permission system and modern UI.
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit; // Exit if accessed directly
}

// Get current user and budget information
$current_user = wp_get_current_user();
$budget_id = isset($_GET['budget_id']) ? intval($_GET['budget_id']) : 0;
$budget_name = '';

if ($budget_id) {
    global $wpdb;
    $budget = $wpdb->get_row(
        $wpdb->prepare("SELECT budget_name FROM {$wpdb->prefix}budgex_budgets WHERE id = %d", $budget_id)
    );
    $budget_name = $budget ? $budget->budget_name : '';
}

?>

<div class="budgex-container">
    <div class="budgex-header">
        <h1 class="budgex-title"><?php _e( '◊î◊ñ◊û◊ü ◊û◊©◊™◊û◊©◊ô◊ù', 'budgex' ); ?></h1>
        <?php if ($budget_name): ?>
        <p class="budgex-subtitle">
            <?php printf( __( '◊î◊ñ◊û◊ü ◊û◊©◊™◊û◊©◊ô◊ù ◊ú◊™◊ß◊¶◊ô◊ë: %s', 'budgex' ), esc_html($budget_name) ); ?>
        </p>
        <?php endif; ?>
    </div>

    <?php if ($budget_id): ?>
    <form id="invite-form" class="budgex-form" method="post" action="">
        <h3><?php _e( '◊î◊ñ◊û◊ü ◊û◊©◊™◊û◊© ◊ó◊ì◊©', 'budgex' ); ?></h3>
        
        <div class="form-row">
            <div class="form-group">
                <label for="invite_email" class="form-label">
                    <?php _e( '◊õ◊™◊ï◊ë◊™ ◊ê◊ô◊û◊ô◊ô◊ú:', 'budgex' ); ?> *
                </label>
                <input 
                    type="email" 
                    id="invite_email" 
                    name="invite_email" 
                    class="form-input" 
                    placeholder="<?php _e( '◊î◊õ◊†◊° ◊õ◊™◊ï◊ë◊™ ◊ê◊ô◊û◊ô◊ô◊ú', 'budgex' ); ?>"
                    required
                >
            </div>

            <div class="form-group">
                <label for="invite_role" class="form-label">
                    <?php _e( '◊™◊§◊ß◊ô◊ì:', 'budgex' ); ?> *
                </label>
                <select id="invite_role" name="invite_role" class="form-select" required>
                    <option value=""><?php _e( '◊ë◊ó◊® ◊™◊§◊ß◊ô◊ì', 'budgex' ); ?></option>
                    <option value="viewer"><?php _e( '◊¶◊ï◊§◊î', 'budgex' ); ?></option>
                    <option value="admin"><?php _e( '◊û◊†◊î◊ú', 'budgex' ); ?></option>
                </select>
                <small class="form-help">
                    <?php _e( '◊¶◊ï◊§◊î: ◊ô◊õ◊ï◊ú ◊ú◊®◊ê◊ï◊™ ◊ê◊™ ◊î◊™◊ß◊¶◊ô◊ë ◊ï◊î◊™◊ï◊¶◊ê◊ï◊™. ◊û◊†◊î◊ú: ◊ô◊õ◊ï◊ú ◊ú◊¢◊®◊ï◊ö ◊ï◊ú◊†◊î◊ú ◊ê◊™ ◊î◊™◊ß◊¶◊ô◊ë.', 'budgex' ); ?>
                </small>
            </div>
        </div>

        <div class="form-group">
            <label for="invite_message" class="form-label">
                <?php _e( '◊î◊ï◊ì◊¢◊î ◊ê◊ô◊©◊ô◊™ (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô):', 'budgex' ); ?>
            </label>
            <textarea 
                id="invite_message" 
                name="invite_message" 
                class="form-textarea" 
                rows="3"
                placeholder="<?php _e( '◊î◊ï◊°◊£ ◊î◊ï◊ì◊¢◊î ◊ê◊ô◊©◊ô◊™ ◊ú◊î◊ñ◊û◊†◊î...', 'budgex' ); ?>"
            ></textarea>
        </div>

        <input type="hidden" name="budget_id" value="<?php echo esc_attr($budget_id); ?>">
        <input type="hidden" name="action" value="budgex_invite_user">
        <?php wp_nonce_field( 'budgex_invite_user_nonce', 'budgex_invite_user_nonce_field' ); ?>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                üìß <?php _e( '◊©◊ú◊ó ◊î◊ñ◊û◊†◊î', 'budgex' ); ?>
            </button>
            <a href="<?php echo esc_url(add_query_arg('id', $budget_id, home_url('/budget-page/'))); ?>" class="btn btn-secondary">
                ‚Ü©Ô∏è <?php _e( '◊ó◊ñ◊ï◊® ◊ú◊™◊ß◊¶◊ô◊ë', 'budgex' ); ?>
            </a>
        </div>
    </form>

    <?php
    // Display existing invitations and permissions
    global $wpdb;
    
    // Get existing permissions
    $permissions = $wpdb->get_results(
        $wpdb->prepare(
            "SELECT s.*, u.display_name, u.user_email 
             FROM {$wpdb->prefix}budgex_budget_shares s
             LEFT JOIN {$wpdb->users} u ON s.user_id = u.ID
             WHERE s.budget_id = %d
             ORDER BY s.role DESC, u.display_name ASC",
            $budget_id
        )
    );

    // Get pending invitations
    $invitations = $wpdb->get_results(
        $wpdb->prepare(
            "SELECT * FROM {$wpdb->prefix}budgex_invitations 
             WHERE budget_id = %d AND status = 'pending'
             ORDER BY created_at DESC",
            $budget_id
        )
    );

    if ($permissions || $invitations): ?>
    <div class="budgex-table">
        <h3><?php _e( '◊û◊©◊™◊û◊©◊ô◊ù ◊ï◊î◊®◊©◊ê◊ï◊™', 'budgex' ); ?></h3>
        
        <?php if ($permissions): ?>
        <h4><?php _e( '◊û◊©◊™◊û◊©◊ô◊ù ◊§◊¢◊ô◊ú◊ô◊ù', 'budgex' ); ?></h4>
        <table>
            <thead>
                <tr>
                    <th><?php _e( '◊û◊©◊™◊û◊©', 'budgex' ); ?></th>
                    <th><?php _e( '◊ê◊ô◊û◊ô◊ô◊ú', 'budgex' ); ?></th>
                    <th><?php _e( '◊™◊§◊ß◊ô◊ì', 'budgex' ); ?></th>
                    <th><?php _e( '◊™◊ê◊®◊ô◊ö ◊î◊¶◊ò◊®◊§◊ï◊™', 'budgex' ); ?></th>
                    <th><?php _e( '◊§◊¢◊ï◊ú◊ï◊™', 'budgex' ); ?></th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($permissions as $permission): ?>
                <tr>
                    <td><?php echo esc_html($permission->display_name ?: __('◊û◊©◊™◊û◊© ◊ú◊ê ◊ñ◊û◊ô◊ü', 'budgex')); ?></td>
                    <td><?php echo esc_html($permission->user_email ?: __('◊ú◊ê ◊ñ◊û◊ô◊ü', 'budgex')); ?></td>
                    <td>
                        <span class="budget-role">
                            <?php echo $permission->role === 'admin' ? __('◊û◊†◊î◊ú', 'budgex') : __('◊¶◊ï◊§◊î', 'budgex'); ?>
                        </span>
                    </td>
                    <td><?php echo esc_html(date_i18n(get_option('date_format'), strtotime($permission->created_at))); ?></td>
                    <td>
                        <?php if ($permission->user_id != $current_user->ID): ?>
                        <button type="button" class="btn btn-sm btn-danger remove-permission" 
                                data-permission-id="<?php echo esc_attr($permission->id); ?>">
                            üóëÔ∏è <?php _e( '◊î◊°◊®', 'budgex' ); ?>
                        </button>
                        <?php else: ?>
                        <span class="text-muted"><?php _e( '◊ë◊¢◊ú◊ô◊ù', 'budgex' ); ?></span>
                        <?php endif; ?>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        <?php endif; ?>

        <?php if ($invitations): ?>
        <h4><?php _e( '◊î◊ñ◊û◊†◊ï◊™ ◊û◊û◊™◊ô◊†◊ï◊™', 'budgex' ); ?></h4>
        <table>
            <thead>
                <tr>
                    <th><?php _e( '◊ê◊ô◊û◊ô◊ô◊ú', 'budgex' ); ?></th>
                    <th><?php _e( '◊™◊§◊ß◊ô◊ì', 'budgex' ); ?></th>
                    <th><?php _e( '◊™◊ê◊®◊ô◊ö ◊©◊ú◊ô◊ó◊î', 'budgex' ); ?></th>
                    <th><?php _e( '◊§◊¢◊ï◊ú◊ï◊™', 'budgex' ); ?></th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($invitations as $invitation): ?>
                <tr>
                    <td><?php echo esc_html($invitation->email); ?></td>
                    <td>
                        <span class="budget-role">
                            <?php echo $invitation->role === 'admin' ? __('◊û◊†◊î◊ú', 'budgex') : __('◊¶◊ï◊§◊î', 'budgex'); ?>
                        </span>
                    </td>
                    <td><?php echo esc_html(date_i18n(get_option('date_format'), strtotime($invitation->created_at))); ?></td>
                    <td>
                        <button type="button" class="btn btn-sm btn-secondary resend-invitation" 
                                data-invitation-id="<?php echo esc_attr($invitation->id); ?>">
                            üìß <?php _e( '◊©◊ú◊ó ◊©◊ï◊ë', 'budgex' ); ?>
                        </button>
                        <button type="button" class="btn btn-sm btn-danger cancel-invitation" 
                                data-invitation-id="<?php echo esc_attr($invitation->id); ?>">
                            ‚ùå <?php _e( '◊ë◊ò◊ú', 'budgex' ); ?>
                        </button>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        <?php endif; ?>
    </div>
    <?php endif; ?>

    <?php else: ?>
    <div class="no-access-container">
        <div class="no-access-icon">‚ö†Ô∏è</div>
        <h2 class="no-access-title"><?php _e( '◊™◊ß◊¶◊ô◊ë ◊ú◊ê ◊†◊û◊¶◊ê', 'budgex' ); ?></h2>
        <p class="no-access-message">
            <?php _e( '◊ú◊ê ◊†◊û◊¶◊ê ◊™◊ß◊¶◊ô◊ë ◊ú◊î◊ñ◊û◊†◊™ ◊û◊©◊™◊û◊©◊ô◊ù. ◊ê◊†◊ê ◊ë◊ó◊® ◊™◊ß◊¶◊ô◊ë ◊ß◊ô◊ô◊ù ◊ê◊ï ◊¶◊ï◊® ◊™◊ß◊¶◊ô◊ë ◊ó◊ì◊©.', 'budgex' ); ?>
        </p>
        <a href="<?php echo esc_url(home_url('/dashboard/')); ?>" class="btn btn-primary">
            üè† <?php _e( '◊ó◊ñ◊ï◊® ◊ú◊ì◊©◊ë◊ï◊®◊ì', 'budgex' ); ?>
        </a>
    </div>
    <?php endif; ?>
</div>

<style>
.form-help {
    color: var(--text-muted);
    font-size: var(--font-size-sm);
    margin-top: var(--spacing-xs);
    display: block;
}

.form-actions {
    display: flex;
    gap: var(--spacing-md);
    justify-content: flex-start;
    margin-top: var(--spacing-xl);
}

@media (max-width: 768px) {
    .form-actions {
        flex-direction: column;
    }
}
</style>

<script>
jQuery(document).ready(function($) {
    // Handle invite form submission
    $('#invite-form').on('submit', function(e) {
        e.preventDefault();
        
        const form = $(this);
        const formData = new FormData(form[0]);
        formData.append('action', 'budgex_send_invitation');
        formData.append('nonce', '<?php echo wp_create_nonce('budgex_invite_nonce'); ?>');

        // Validate form
        let isValid = true;
        form.find('.form-input[required], .form-select[required]').each(function() {
            if (!$(this).val().trim()) {
                $(this).addClass('error');
                isValid = false;
            } else {
                $(this).removeClass('error');
            }
        });

        if (!isValid) {
            BudgexPublic.showNotification('◊ê◊†◊ê ◊û◊ú◊ê ◊ê◊™ ◊õ◊ú ◊î◊©◊ì◊ï◊™ ◊î◊†◊ì◊®◊©◊ô◊ù', 'error');
            return;
        }

        // Show loading
        const submitBtn = form.find('button[type="submit"]');
        submitBtn.prop('disabled', true).html('üîÑ ◊©◊ï◊ú◊ó ◊î◊ñ◊û◊†◊î...');

        $.ajax({
            url: budgex_ajax.ajax_url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    BudgexPublic.showNotification('◊î◊î◊ñ◊û◊†◊î ◊†◊©◊ú◊ó◊î ◊ë◊î◊¶◊ú◊ó◊î!', 'success');
                    form[0].reset();
                    // Reload page to show updated invitations
                    setTimeout(() => location.reload(), 1500);
                } else {
                    BudgexPublic.showNotification(response.data || '◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊î◊ñ◊û◊†◊î', 'error');
                }
            },
            error: function() {
                BudgexPublic.showNotification('◊©◊í◊ô◊ê◊î ◊ë◊ó◊ô◊ë◊ï◊® ◊ú◊©◊®◊™', 'error');
            },
            complete: function() {
                submitBtn.prop('disabled', false).html('üìß ◊©◊ú◊ó ◊î◊ñ◊û◊†◊î');
            }
        });
    });

    // Handle permission removal
    $('.remove-permission').on('click', function() {
        const permissionId = $(this).data('permission-id');
        
        if (!confirm('◊î◊ê◊ù ◊ê◊™◊î ◊ë◊ò◊ï◊ó ◊©◊ë◊®◊¶◊ï◊†◊ö ◊ú◊î◊°◊ô◊® ◊ê◊™ ◊î◊û◊©◊™◊û◊© ◊û◊î◊™◊ß◊¶◊ô◊ë?')) {
            return;
        }

        $(this).prop('disabled', true);

        $.ajax({
            url: budgex_ajax.ajax_url,
            type: 'POST',
            data: {
                action: 'budgex_remove_permission',
                permission_id: permissionId,
                nonce: '<?php echo wp_create_nonce('budgex_permission_nonce'); ?>'
            },
            success: function(response) {
                if (response.success) {
                    BudgexPublic.showNotification('◊î◊û◊©◊™◊û◊© ◊î◊ï◊°◊® ◊ë◊î◊¶◊ú◊ó◊î', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    BudgexPublic.showNotification(response.data || '◊©◊í◊ô◊ê◊î ◊ë◊î◊°◊®◊™ ◊î◊û◊©◊™◊û◊©', 'error');
                }
            },
            error: function() {
                BudgexPublic.showNotification('◊©◊í◊ô◊ê◊î ◊ë◊ó◊ô◊ë◊ï◊® ◊ú◊©◊®◊™', 'error');
            },
            complete: function() {
                $(this).prop('disabled', false);
            }
        });
    });

    // Handle invitation cancellation
    $('.cancel-invitation').on('click', function() {
        const invitationId = $(this).data('invitation-id');
        
        if (!confirm('◊î◊ê◊ù ◊ê◊™◊î ◊ë◊ò◊ï◊ó ◊©◊ë◊®◊¶◊ï◊†◊ö ◊ú◊ë◊ò◊ú ◊ê◊™ ◊î◊î◊ñ◊û◊†◊î?')) {
            return;
        }

        $(this).prop('disabled', true);

        $.ajax({
            url: budgex_ajax.ajax_url,
            type: 'POST',
            data: {
                action: 'budgex_cancel_invitation',
                invitation_id: invitationId,
                nonce: '<?php echo wp_create_nonce('budgex_invitation_nonce'); ?>'
            },
            success: function(response) {
                if (response.success) {
                    BudgexPublic.showNotification('◊î◊î◊ñ◊û◊†◊î ◊ë◊ï◊ò◊ú◊î ◊ë◊î◊¶◊ú◊ó◊î', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    BudgexPublic.showNotification(response.data || '◊©◊í◊ô◊ê◊î ◊ë◊ë◊ô◊ò◊ï◊ú ◊î◊î◊ñ◊û◊†◊î', 'error');
                }
            },
            error: function() {
                BudgexPublic.showNotification('◊©◊í◊ô◊ê◊î ◊ë◊ó◊ô◊ë◊ï◊® ◊ú◊©◊®◊™', 'error');
            },
            complete: function() {
                $(this).prop('disabled', false);
            }
        });
    });

    // Handle invitation resend
    $('.resend-invitation').on('click', function() {
        const invitationId = $(this).data('invitation-id');
        
        $(this).prop('disabled', true).html('üîÑ ◊©◊ï◊ú◊ó...');

        $.ajax({
            url: budgex_ajax.ajax_url,
            type: 'POST',
            data: {
                action: 'budgex_resend_invitation',
                invitation_id: invitationId,
                nonce: '<?php echo wp_create_nonce('budgex_invitation_nonce'); ?>'
            },
            success: function(response) {
                if (response.success) {
                    BudgexPublic.showNotification('◊î◊î◊ñ◊û◊†◊î ◊†◊©◊ú◊ó◊î ◊©◊ï◊ë ◊ë◊î◊¶◊ú◊ó◊î', 'success');
                } else {
                    BudgexPublic.showNotification(response.data || '◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊î◊ñ◊û◊†◊î', 'error');
                }
            },
            error: function() {
                BudgexPublic.showNotification('◊©◊í◊ô◊ê◊î ◊ë◊ó◊ô◊ë◊ï◊® ◊ú◊©◊®◊™', 'error');
            },
            complete: function() {
                $(this).prop('disabled', false).html('üìß ◊©◊ú◊ó ◊©◊ï◊ë');
            }
        });
    });
});
</script>